1. Структура заголовка IPv4 (стандартный вариант)

Заголовок IPv4 имеет переменную длину (от 20 до 60 байт) и состоит из следующих ключевых полей: 

- **Version (Версия):** 4 бита, для IPv4 всегда равна `4`.
- **IHL (Internet Header Length):** длина самого заголовка. Минимум 20 байт.
- **Type of Service (ToS):** приоритет пакета (важно для видеосвязи или игр, чтобы данные шли без задержек).
- **Total Length:** общая длина всего пакета (заголовок + данные). Максимум — 65 535 байт.
- **Identification, Flags, Fragment Offset:** группа полей для **фрагментации**. Если пакет слишком большой для какой-то сети, роутер разбивает его на части, а эти поля помогают собрать их обратно в правильном порядке.
- **TTL (Time to Live):** «время жизни» пакета в прыжках (хопах) через роутеры. Каждый роутер вычитает 1. Когда TTL становится равен 0, пакет удаляется, чтобы он не «гулял» по сети вечно.
- **Protocol:** указывает, какой протокол находится внутри (например, TCP или UDP).
- **Header Checksum:** контрольная сумма для проверки, не повредился ли заголовок при передаче.
- **Source & Destination IP Addresses:** 32-битные адреса отправителя и получателя. 

2. Структура заголовка IPv6 (современный вариант)

Заголовок IPv6 был упрощен для ускорения работы роутеров. Он имеет **фиксированную длину 40 байт**. 

- В нем больше нет полей для фрагментации и контрольной суммы (это ускоряет обработку).
- **Адреса:** занимают большую часть заголовка, так как они теперь 128-битные.
- **Flow Label:** новое поле, которое позволяет помечать конкретный «поток» данных (например, видеострим), чтобы роутеры обрабатывали его единообразно. 

3. Полезная нагрузка (Payload)

Это те самые данные, которые вы передаете: часть веб-страницы, фрагмент сообщения в мессенджере или кусочек видео. Обычно внутри IP-пакета «инкапсулирован» (вложен) сегмент более высокого уровня, например **TCP** или **UDP**. 

| Характеристика        | IPv4 пакет                           | IPv6 пакет                                  |
| --------------------- | ------------------------------------ | ------------------------------------------- |
| **Длина заголовка**   | Переменная (20–60 байт)              | Фиксированная (40 байт)                     |
| **Размер адреса**     | 32 бита                              | 128 бит                                     |
| **Фрагментация**      | Выполняется роутерами и отправителем | Только отправителем                         |
| **Контрольная сумма** | Есть в каждом заголовке              | Отсутствует (проверяется на других уровнях) |
Протокол IP поддерживает фрагментацию IP-датаграмм. Cуть фрагментации заключается в том, что максимальный размер передаваемых данных в одной IP-датаграмме составляет 65535 байт (октетов), а максимальный размер данных, который может поместиться в PDU канального уровня (MTU), гораздо меньше (обычно он составляет 1500 или около байт). Если размер IP-датаграммы больше MTU, она будет разбита на несколько IP-пакетов, каждый из которых можно будет передать в PDU канального уровня. При получении IP-пакетов они будут собраны в IP-датаграмму, и она будет разобрана на транспортном уровне.

Структура ARP-сообщения

ARP работает прямо «поверх» канального уровня (Ethernet), у него нет заголовков IP. Вот основные поля типичного ARP-запроса или ответа:

1. **Hardware Type (Тип оборудования):** Тип протокола канального уровня (для Ethernet это значение `1`).
2. **Protocol Type (Тип протокола):** Для какого сетевого протокола ищем адрес (для IPv4 это `0x0800`).
3. **Hardware Size (Длина мак-адреса):** Для Ethernet это `6` байт.
4. **Protocol Size (Длина IP-адреса):** Для IPv4 это `4` байта.
5. **Opcode (Код операции):** Самое важное поле. Оно определяет тип сообщения:
    - `1` — ARP Request (Запрос: «Кто здесь 192.168.0.1?»)
    - `2` — ARP Reply (Ответ: «Я 192.168.0.1, мой MAC такой-то...»)
6. **Sender Hardware Address:** MAC-адрес отправителя.
7. **Sender Protocol Address:** IP-адрес отправителя.
8. **Target Hardware Address:** MAC-адрес получателя (в запросе это поле заполнено нулями, так как мы его еще не знаем).
9. **Target Protocol Address:** IP-адрес того, кого мы ищем


**Полнодуплексное соединение (Full-Duplex)** — это ==режим работы связи, при котором передача и прием данных происходят **одновременно** в обоих направлениях==.

Если проводить аналогии с жизнью:

- **Симплекс:** Радио или ТВ. Вы только слушаете, ответить нельзя.
- **Полудуплекс (Half-Duplex):** Рация. Говорит либо один, либо другой. Если нажать кнопку одновременно — никто никого не услышит.
- **Полный дуплекс (Full-Duplex):** Мобильный телефон. Вы можете одновременно и говорить, и слушать собеседника.

Структура заголовка TCP

Заголовок TCP обычно занимает **20 байт** (без учета дополнительных опций). Вот его ключевые поля:

1. **Source Port (Порт отправителя) и Destination Port (Порт получателя) — по 16 бит:**  
    Определяют, какому приложению предназначены данные (например, 80 или 443 для браузера). IP-адрес доставляет пакет до компьютера, а порт — до конкретной программы.
2. **Sequence Number (Порядковый номер) — 32 бита:**  
    TCP разбивает большой файл на куски. Каждый сегмент получает свой номер, чтобы компьютер получателя мог собрать их в правильном порядке, даже если они прилетели вразнобой.
3. **Acknowledgment Number (Номер подтверждения) — 32 бита:**  
    Используется для ответа. Получатель пишет здесь номер следующего байта, который он ожидает получить. Это подтверждение: «Я получил всё до номера X, присылай X+1».
4. **Data Offset (Смещение данных):**  
    Показывает длину заголовка TCP, чтобы компьютер знал, где начинаются реальные данные.
5. **Flags (Флаги) — 9 бит:**  
    Управляющие «сигналы» для управления соединением:
    - **SYN:** Запрос на установку соединения («Привет, давай свяжемся?»).
    - **ACK:** Подтверждение («Принято»).
    - **FIN:** Запрос на разрыв («Я всё отправил, пока»).
    - **RST:** Сброс соединения (ошибка или отказ).
    - **PSH:** Просьба немедленно передать данные приложению, не дожидаясь заполнения буфера.
6. **Window Size (Размер окна) — 16 бит:**  
    Поле для управления потоком. Получатель сообщает, сколько байт он готов принять прямо сейчас, чтобы его не «затопило» трафиком.
7. **Checksum (Контрольная сумма):**  
    Проверка целостности данных в сегменте.
8. **Urgent Pointer:**  
    Используется, если часть данных помечена как «срочная».

---

Как это работает вместе: «Тройное рукопожатие»

TCP не просто шлет пакеты, он сначала «договаривается», используя флаги:

1. Вы посылаете **SYN** (хочу соединиться).
2. Сервер отвечает **SYN + ACK** (слышу тебя, я тоже согласен).
3. Вы отвечаете **ACK** (отлично, начинаю передачу).

В чем главное отличие от IP-пакета?

В IP-заголовке есть адреса «дом-улица», но нет механизма контроля доставки. Если IP-пакет потеряется — он просто исчезнет. TCP же увидит, что **Sequence Number** пропущен, и попросит отправителя выслать этот кусок данных заново.